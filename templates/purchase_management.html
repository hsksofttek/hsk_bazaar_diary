{% extends "base.html" %}

{% block title %}Purchase Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Purchase Management</h1>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#purchaseEntryModal">
                        <i class="fas fa-plus"></i> New Purchase Entry
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#purchaseOrderModal">
                        <i class="fas fa-file-alt"></i> Purchase Order
                    </button>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#purchaseReturnModal">
                        <i class="fas fa-undo"></i> Purchase Return
                    </button>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#purchasePaymentModal">
                        <i class="fas fa-money-bill"></i> Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                This Month Purchases</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="currentMonthAmount">₹0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Bills</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBills">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-receipt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Payments</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingAmount">₹0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Growth</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="growthPercentage">0%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Filters</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="startDate">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label for="partyFilter">Supplier</label>
                            <select class="form-control" id="partyFilter">
                                <option value="">All Suppliers</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="itemFilter">Item</label>
                            <select class="form-control" id="itemFilter">
                                <option value="">All Items</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary" onclick="loadPurchases()">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button class="btn btn-success" onclick="exportData()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase List -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Purchase Transactions</h6>
                    <div>
                        <span class="badge badge-primary" id="totalCount">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="purchaseTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Bill No</th>
                                    <th>Date</th>
                                    <th>Supplier</th>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Weight</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadPreviousPage()" id="prevBtn" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadNextPage()" id="nextBtn">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div>
                            <span id="pageInfo">Page 1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Entry Modal -->
<div class="modal fade" id="purchaseEntryModal" tabindex="-1" aria-labelledby="purchaseEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchaseEntryModalLabel">New Purchase Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="purchaseEntryForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="billNo">Bill No *</label>
                            <input type="number" class="form-control" id="billNo" required>
                        </div>
                        <div class="col-md-3">
                            <label for="billDate">Bill Date *</label>
                            <input type="date" class="form-control" id="billDate" required>
                        </div>
                        <div class="col-md-3">
                            <label for="orderNo">Order No</label>
                            <input type="text" class="form-control" id="orderNo">
                        </div>
                        <div class="col-md-3">
                            <label for="orderDate">Order Date</label>
                            <input type="date" class="form-control" id="orderDate">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label for="partyCode">Supplier Code *</label>
                            <select class="form-control" id="partyCode" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="transCode">Transport Code</label>
                            <input type="text" class="form-control" id="transCode">
                        </div>
                        <div class="col-md-4">
                            <label for="lrNo">LR No</label>
                            <input type="text" class="form-control" id="lrNo">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label for="itemCode">Item Code *</label>
                            <select class="form-control" id="itemCode" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="qty">Quantity</label>
                            <input type="number" class="form-control" id="qty" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="katta">Katta</label>
                            <input type="number" class="form-control" id="katta" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="rate">Rate</label>
                            <input type="number" step="0.01" class="form-control" id="rate" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="totalWeight">Total Weight</label>
                            <input type="number" step="0.01" class="form-control" id="totalWeight" readonly>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-2">
                            <label for="taxPercent">Tax %</label>
                            <input type="number" step="0.01" class="form-control" id="taxPercent" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="discountPercent">Discount %</label>
                            <input type="number" step="0.01" class="form-control" id="discountPercent" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="adat">Adat</label>
                            <input type="number" step="0.01" class="form-control" id="adat" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="hamali">Hamali</label>
                            <input type="number" step="0.01" class="form-control" id="hamali" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="other">Other</label>
                            <input type="number" step="0.01" class="form-control" id="other" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="totalAmount">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label for="transport">Transport</label>
                            <input type="text" class="form-control" id="transport">
                        </div>
                        <div class="col-md-4">
                            <label for="truckNo">Truck No</label>
                            <input type="text" class="form-control" id="truckNo">
                        </div>
                        <div class="col-md-4">
                            <label for="paymentTerms">Payment Terms</label>
                            <input type="text" class="form-control" id="paymentTerms" placeholder="e.g., 30 days">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="remarks">Remarks</label>
                            <textarea class="form-control" id="remarks" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePurchaseEntry()">Save Purchase</button>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Order Modal -->
<div class="modal fade" id="purchaseOrderModal" tabindex="-1" aria-labelledby="purchaseOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchaseOrderModalLabel">New Purchase Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="purchaseOrderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="poOrderNo">Order No *</label>
                            <input type="text" class="form-control" id="poOrderNo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="poOrderDate">Order Date *</label>
                            <input type="date" class="form-control" id="poOrderDate" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="poPartyCode">Supplier *</label>
                            <select class="form-control" id="poPartyCode" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="poExpectedDate">Expected Date</label>
                            <input type="date" class="form-control" id="poExpectedDate">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="poRemarks">Remarks</label>
                            <textarea class="form-control" id="poRemarks" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePurchaseOrder()">Save Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Return Modal -->
<div class="modal fade" id="purchaseReturnModal" tabindex="-1" aria-labelledby="purchaseReturnModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchaseReturnModalLabel">Purchase Return</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="purchaseReturnForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="returnNo">Return No *</label>
                            <input type="number" class="form-control" id="returnNo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="returnDate">Return Date *</label>
                            <input type="date" class="form-control" id="returnDate" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="originalBillNo">Original Bill No *</label>
                            <input type="number" class="form-control" id="originalBillNo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="returnPartyCode">Supplier *</label>
                            <select class="form-control" id="returnPartyCode" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label for="returnItemCode">Item Code *</label>
                            <select class="form-control" id="returnItemCode" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="returnQty">Quantity</label>
                            <input type="number" class="form-control" id="returnQty" value="0">
                        </div>
                        <div class="col-md-4">
                            <label for="returnRate">Rate</label>
                            <input type="number" step="0.01" class="form-control" id="returnRate" value="0">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="returnType">Return Type</label>
                            <select class="form-control" id="returnType">
                                <option value="DAMAGE">Damage</option>
                                <option value="QUALITY">Quality Issue</option>
                                <option value="WRONG_ITEM">Wrong Item</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="returnReason">Reason</label>
                            <input type="text" class="form-control" id="returnReason">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePurchaseReturn()">Save Return</button>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Payment Modal -->
<div class="modal fade" id="purchasePaymentModal" tabindex="-1" aria-labelledby="purchasePaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchasePaymentModalLabel">Purchase Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="purchasePaymentForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="paymentNo">Payment No *</label>
                            <input type="number" class="form-control" id="paymentNo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentDate">Payment Date *</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="paymentPartyCode">Supplier *</label>
                            <select class="form-control" id="paymentPartyCode" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentAmount">Payment Amount *</label>
                            <input type="number" step="0.01" class="form-control" id="paymentAmount" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="paymentMode">Payment Mode</label>
                            <select class="form-control" id="paymentMode">
                                <option value="CASH">Cash</option>
                                <option value="CHEQUE">Cheque</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="UPI">UPI</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="referenceNo">Reference No</label>
                            <input type="text" class="form-control" id="referenceNo">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="bankName">Bank Name</label>
                            <input type="text" class="form-control" id="bankName">
                        </div>
                        <div class="col-md-6">
                            <label for="chequeDate">Cheque Date</label>
                            <input type="date" class="form-control" id="chequeDate">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="paymentRemarks">Remarks</label>
                            <textarea class="form-control" id="paymentRemarks" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePurchasePayment()">Save Payment</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 0;
let pageSize = 50;
let totalCount = 0;

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadPurchases();
    loadParties();
    loadItems();
    setDefaultDates();
});

function setDefaultDates() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('billDate').value = today.toISOString().split('T')[0];
    document.getElementById('poOrderDate').value = today.toISOString().split('T')[0];
    document.getElementById('returnDate').value = today.toISOString().split('T')[0];
    document.getElementById('paymentDate').value = today.toISOString().split('T')[0];
}

function loadStatistics() {
    fetch('/api/purchase/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.statistics;
                document.getElementById('currentMonthAmount').textContent = '₹' + stats.current_month.total_amount.toLocaleString();
                document.getElementById('totalBills').textContent = stats.current_month.total_bills;
                document.getElementById('pendingAmount').textContent = '₹' + stats.pending_payments.total_amount.toLocaleString();
                document.getElementById('growthPercentage').textContent = stats.growth_percentage + '%';
            }
        })
        .catch(error => console.error('Error loading statistics:', error));
}

function loadPurchases() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const partyCd = document.getElementById('partyFilter').value;
    const itemCd = document.getElementById('itemFilter').value;
    
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate,
        party_cd: partyCd,
        it_cd: itemCd,
        limit: pageSize,
        offset: currentPage * pageSize
    });
    
    fetch(`/api/purchase/list?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPurchases(data.purchases);
                totalCount = data.total_count;
                updatePagination();
            }
        })
        .catch(error => console.error('Error loading purchases:', error));
}

function displayPurchases(purchases) {
    const tbody = document.getElementById('purchaseTableBody');
    tbody.innerHTML = '';
    
    purchases.forEach(purchase => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${purchase.bill_no}</td>
            <td>${purchase.bill_date}</td>
            <td>${purchase.party_cd}</td>
            <td>${purchase.it_cd}</td>
            <td>${purchase.qty}</td>
            <td>${purchase.tot_smt}</td>
            <td>₹${purchase.rate}</td>
            <td>₹${purchase.tot_amt}</td>
            <td><span class="badge badge-${getStatusBadge(purchase.payment_status)}">${purchase.payment_status}</span></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewPurchase(${purchase.bill_no})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editPurchase(${purchase.bill_no})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePurchase(${purchase.bill_no})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('totalCount').textContent = totalCount;
}

function getStatusBadge(status) {
    switch(status) {
        case 'PAID': return 'success';
        case 'PARTIAL': return 'warning';
        case 'PENDING': return 'danger';
        default: return 'secondary';
    }
}

function updatePagination() {
    const totalPages = Math.ceil(totalCount / pageSize);
    const currentPageNum = currentPage + 1;
    
    document.getElementById('pageInfo').textContent = `Page ${currentPageNum} of ${totalPages}`;
    document.getElementById('prevBtn').disabled = currentPage === 0;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
}

function loadPreviousPage() {
    if (currentPage > 0) {
        currentPage--;
        loadPurchases();
    }
}

function loadNextPage() {
    const totalPages = Math.ceil(totalCount / pageSize);
    if (currentPage < totalPages - 1) {
        currentPage++;
        loadPurchases();
    }
}

function resetFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('partyFilter').value = '';
    document.getElementById('itemFilter').value = '';
    currentPage = 0;
    loadPurchases();
}

function loadParties() {
    fetch('/api/parties')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const parties = data.parties;
                const partySelects = ['partyCode', 'poPartyCode', 'returnPartyCode', 'paymentPartyCode', 'partyFilter'];
                
                partySelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Supplier</option>';
                        parties.forEach(party => {
                            const option = document.createElement('option');
                            option.value = party.party_cd;
                            option.textContent = `${party.party_cd} - ${party.party_nm}`;
                            select.appendChild(option);
                        });
                    }
                });
            }
        })
        .catch(error => console.error('Error loading parties:', error));
}

function loadItems() {
    fetch('/api/items')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const items = data.items;
                const itemSelects = ['itemCode', 'returnItemCode', 'itemFilter'];
                
                itemSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Item</option>';
                        items.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.it_cd;
                            option.textContent = `${item.it_cd} - ${item.it_nm}`;
                            select.appendChild(option);
                        });
                    }
                });
            }
        })
        .catch(error => console.error('Error loading items:', error));
}

// Calculate total weight when qty or katta changes
document.getElementById('qty').addEventListener('input', calculateAmounts);
document.getElementById('katta').addEventListener('input', calculateAmounts);
document.getElementById('rate').addEventListener('input', calculateAmounts);
document.getElementById('taxPercent').addEventListener('input', calculateAmounts);
document.getElementById('discountPercent').addEventListener('input', calculateAmounts);
document.getElementById('adat').addEventListener('input', calculateAmounts);
document.getElementById('hamali').addEventListener('input', calculateAmounts);
document.getElementById('other').addEventListener('input', calculateAmounts);

function calculateAmounts() {
    const qty = parseFloat(document.getElementById('qty').value) || 0;
    const katta = parseFloat(document.getElementById('katta').value) || 0;
    const rate = parseFloat(document.getElementById('rate').value) || 0;
    const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
    const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
    const adat = parseFloat(document.getElementById('adat').value) || 0;
    const hamali = parseFloat(document.getElementById('hamali').value) || 0;
    const other = parseFloat(document.getElementById('other').value) || 0;
    
    const totalWeight = qty * katta;
    const saleAmount = totalWeight * rate;
    const taxAmount = (saleAmount * taxPercent) / 100;
    const discountAmount = (saleAmount * discountPercent) / 100;
    const totalAmount = saleAmount + taxAmount - discountAmount + adat + hamali + other;
    
    document.getElementById('totalWeight').value = totalWeight.toFixed(2);
    document.getElementById('totalAmount').value = totalAmount.toFixed(2);
}

function savePurchaseEntry() {
    const formData = {
        bill_no: parseInt(document.getElementById('billNo').value),
        bill_date: document.getElementById('billDate').value,
        party_cd: document.getElementById('partyCode').value,
        it_cd: document.getElementById('itemCode').value,
        order_no: document.getElementById('orderNo').value,
        order_dt: document.getElementById('orderDate').value,
        trans_cd: document.getElementById('transCode').value,
        lr_no: document.getElementById('lrNo').value,
        qty: parseInt(document.getElementById('qty').value) || 0,
        katta: parseInt(document.getElementById('katta').value) || 0,
        rate: parseFloat(document.getElementById('rate').value) || 0,
        taxp: parseFloat(document.getElementById('taxPercent').value) || 0,
        cdisp: parseFloat(document.getElementById('discountPercent').value) || 0,
        adat: parseFloat(document.getElementById('adat').value) || 0,
        hamali: parseFloat(document.getElementById('hamali').value) || 0,
        other: parseFloat(document.getElementById('other').value) || 0,
        transport: document.getElementById('transport').value,
        truck_no: document.getElementById('truckNo').value,
        payment_terms: document.getElementById('paymentTerms').value,
        remark: document.getElementById('remarks').value
    };
    
    fetch('/api/purchase/entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase entry saved successfully!');
            document.getElementById('purchaseEntryForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('purchaseEntryModal')).hide();
            loadPurchases();
            loadStatistics();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving purchase entry');
    });
}

function savePurchaseOrder() {
    const formData = {
        order_no: document.getElementById('poOrderNo').value,
        order_date: document.getElementById('poOrderDate').value,
        party_cd: document.getElementById('poPartyCode').value,
        expected_date: document.getElementById('poExpectedDate').value,
        remarks: document.getElementById('poRemarks').value
    };
    
    fetch('/api/purchase/order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase order saved successfully!');
            document.getElementById('purchaseOrderForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('purchaseOrderModal')).hide();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving purchase order');
    });
}

function savePurchaseReturn() {
    const formData = {
        return_no: parseInt(document.getElementById('returnNo').value),
        return_date: document.getElementById('returnDate').value,
        original_bill_no: parseInt(document.getElementById('originalBillNo').value),
        party_cd: document.getElementById('returnPartyCode').value,
        it_cd: document.getElementById('returnItemCode').value,
        qty: parseInt(document.getElementById('returnQty').value) || 0,
        rate: parseFloat(document.getElementById('returnRate').value) || 0,
        return_type: document.getElementById('returnType').value,
        reason: document.getElementById('returnReason').value
    };
    
    fetch('/api/purchase/return', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase return saved successfully!');
            document.getElementById('purchaseReturnForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('purchaseReturnModal')).hide();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving purchase return');
    });
}

function savePurchasePayment() {
    const formData = {
        payment_no: parseInt(document.getElementById('paymentNo').value),
        payment_date: document.getElementById('paymentDate').value,
        party_cd: document.getElementById('paymentPartyCode').value,
        payment_amount: parseFloat(document.getElementById('paymentAmount').value) || 0,
        payment_mode: document.getElementById('paymentMode').value,
        reference_no: document.getElementById('referenceNo').value,
        bank_name: document.getElementById('bankName').value,
        cheque_date: document.getElementById('chequeDate').value,
        remarks: document.getElementById('paymentRemarks').value
    };
    
    fetch('/api/purchase/payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase payment saved successfully!');
            document.getElementById('purchasePaymentForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('purchasePaymentModal')).hide();
            loadStatistics();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving purchase payment');
    });
}

function viewPurchase(billNo) {
    fetch(`/api/purchase/${billNo}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display purchase details in a modal or new page
                console.log('Purchase details:', data);
                alert('View functionality to be implemented');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading purchase details');
        });
}

function editPurchase(billNo) {
    // Implement edit functionality
    alert('Edit functionality to be implemented');
}

function deletePurchase(billNo) {
    if (confirm('Are you sure you want to delete this purchase entry?')) {
        // Implement delete functionality
        alert('Delete functionality to be implemented');
    }
}

function exportData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const partyCd = document.getElementById('partyFilter').value;
    const itemCd = document.getElementById('itemFilter').value;
    
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate,
        party_cd: partyCd,
        it_cd: itemCd
    });
    
    // Create download link
    const link = document.createElement('a');
    link.href = `/api/purchase/reports/summary?${params}&format=csv`;
    link.download = `purchases_${startDate}_${endDate}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %} 