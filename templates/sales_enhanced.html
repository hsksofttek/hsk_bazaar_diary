{% extends "base.html" %}

{% block title %}Enhanced Sales Management - Business Management System{% endblock %}
{% block page_title %}Modern Sales Management{% endblock %}

{% block content %}
<!-- Enhanced Header with Live Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-gradient-primary text-white">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 class="mb-0">
                            <i class="fas fa-cash-register me-2"></i>Sales Management
                        </h4>
                        <p class="mb-0">Manage your sales transactions and invoices</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="row">
                            <div class="col-4">
                                <div class="text-center">
                                    <h3 id="totalSales">0</h3>
                                    <small>Total Sales</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <h3 id="monthlySales">0</h3>
                                    <small>This Month</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <h3 id="todaySales">0</h3>
                                    <small>Today</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Search and Actions -->
<div class="row mb-4">
    <div class="col-md-8">
        <!-- Search Bar -->
        <div class="input-group mb-4">
            <span class="input-group-text">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" 
                   class="form-control form-control-lg" 
                   id="searchInput"
                   placeholder="Type to search sales (bill number, customer, item)...">
            <button class="btn btn-outline-secondary" 
                    onclick="toggleFilters()">
                <i class="fas fa-filter"></i>
            </button>
        </div>
        
        <!-- Advanced Filters -->
        <div class="card mb-4" id="advancedFiltersCard" style="display: none;">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Advanced Filters
                    <button class="btn btn-sm btn-outline-secondary float-end" 
                            onclick="toggleFilters()">
                        <i class="fas fa-chevron-down" id="filterChevron"></i>
                    </button>
                </h6>
            </div>
            <div class="card-body" id="filterBody" style="display: none;">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <select class="form-control" id="dateFilter">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer</label>
                        <select class="form-control" id="customerFilter">
                            <option value="">All Customers</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Amount Range</label>
                        <select class="form-control" id="amountFilter">
                            <option value="">All Amounts</option>
                            <option value="0-1000">₹0 - ₹1,000</option>
                            <option value="1000-5000">₹1,000 - ₹5,000</option>
                            <option value="5000-10000">₹5,000 - ₹10,000</option>
                            <option value="10000+">₹10,000+</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sort By</label>
                        <select class="form-control" id="sortByFilter">
                            <option value="date">Date</option>
                            <option value="amount">Amount</option>
                            <option value="customer">Customer</option>
                            <option value="bill_no">Bill Number</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 text-end">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i>Apply Filters
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 text-end">
        <button class="btn btn-success btn-lg" onclick="openAddSaleModal()">
            <i class="fas fa-plus me-2"></i>Add Sale
        </button>
    </div>
</div>

<!-- Enhanced Sales Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-cash-register me-2"></i>Sales
        </h5>
        <div class="btn-group" role="group">
            <button class="btn btn-sm btn-outline-primary" onclick="loadSalesTable()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="exportSales()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Results Summary -->
        <div class="d-flex justify-content-between align-items-center p-3">
            <div>
                <span class="text-muted" id="resultsCount">Loading sales...</span>
            </div>
        </div>
        <div id="salesTable">
            <!-- Table will be loaded here by JavaScript -->
        </div>
    </div>
</div>

<!-- Sale Modal -->
<div class="modal fade" id="saleModal" tabindex="-1" aria-labelledby="saleModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <!-- Modal content will be loaded here by JavaScript -->
        </div>
    </div>
</div>

{% endblock %}

{% block head %}
<style>
/* Enhanced Sales Management Styles */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.card.bg-gradient-primary {
    border: none !important;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
}

.card.bg-gradient-primary .card-body {
    padding: 1.5rem !important;
}

.card.bg-gradient-primary h4 {
    color: white !important;
    font-weight: 600 !important;
    margin-bottom: 0.5rem !important;
}

.card.bg-gradient-primary p {
    color: rgba(255, 255, 255, 0.9) !important;
    margin-bottom: 0 !important;
}

.card.bg-gradient-primary h3 {
    color: white !important;
    font-weight: 700 !important;
    font-size: 2rem !important;
    margin-bottom: 0.25rem !important;
}

.card.bg-gradient-primary small {
    color: rgba(255, 255, 255, 0.8) !important;
    font-size: 0.875rem !important;
}

.sale-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.items-badge {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.action-buttons {
    display: flex;
    gap: 0.25rem;
}

.btn-action {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.btn-view {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.btn-edit {
    background-color: #fff3e0;
    color: #f57c00;
    border: 1px solid #ffcc02;
}

.btn-delete {
    background-color: #ffebee;
    color: #d32f2f;
    border: 1px solid #ffcdd2;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Table Enhancements */
.table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
}

.table td {
    vertical-align: middle;
    border-color: #e9ecef;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.001);
    transition: all 0.2s ease;
}

/* Modal Enhancements */
.modal-content {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 1rem 1rem 0 0;
    border-bottom: none;
}

.modal-title {
    font-weight: 600;
    font-size: 1.2rem;
}

.btn-close {
    filter: invert(1);
    opacity: 1;
}

.modal .form-control {
    border: 2px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.modal .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.modal .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
}

.modal .btn {
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

/* Remove modal backdrop completely */
.modal-backdrop {
    display: none !important;
    opacity: 0 !important;
}

/* Modal positioning */
.modal-dialog-centered {
    display: flex !important;
    align-items: center !important;
    min-height: calc(100% - 1rem) !important;
}

/* Ensure scrollbar is always visible */
html, body {
    overflow-y: auto !important;
    overflow-x: hidden !important;
}

body {
    overflow-y: scroll !important;
}

.modal {
    overflow-y: auto !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let searchTimeout;

// Load stats on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sales enhanced page loaded');
    ensureHeaderVisible();
    loadStats();
    loadSalesTable();
    setTimeout(addActionListeners, 1000);
});

function ensureHeaderVisible() {
    console.log('Ensuring header is visible...');
    const totalElement = document.getElementById('totalSales');
    const monthlyElement = document.getElementById('monthlySales');
    const todayElement = document.getElementById('todaySales');
    
    if (totalElement) { totalElement.textContent = '0'; console.log('Set totalSales to 0'); } else { console.error('totalSales element not found'); }
    if (monthlyElement) { monthlyElement.textContent = '0'; console.log('Set monthlySales to 0'); } else { console.error('monthlySales element not found'); }
    if (todayElement) { todayElement.textContent = '0'; console.log('Set todaySales to 0'); } else { console.error('todaySales element not found'); }
}

// Load stats
function loadStats() {
    console.log('Loading sales stats...');
    
    // Load total sales
    fetch('/api/sales/stats/total')
        .then(response => response.text())
        .then(data => {
            console.log('Total sales:', data);
            document.getElementById('totalSales').textContent = data;
        })
        .catch(error => {
            console.error('Error loading total sales:', error);
            document.getElementById('totalSales').textContent = '0';
        });
    
    // Load monthly sales
    fetch('/api/sales/stats/monthly')
        .then(response => response.text())
        .then(data => {
            console.log('Monthly sales:', data);
            document.getElementById('monthlySales').textContent = data;
        })
        .catch(error => {
            console.error('Error loading monthly sales:', error);
            document.getElementById('monthlySales').textContent = '0';
        });
    
    // Load today's sales
    fetch('/api/sales/stats/today')
        .then(response => response.text())
        .then(data => {
            console.log('Today sales:', data);
            document.getElementById('todaySales').textContent = data;
        })
        .catch(error => {
            console.error('Error loading today sales:', error);
            document.getElementById('todaySales').textContent = '0';
        });
}

// Load sales table
function loadSalesTable() {
    console.log('Loading sales table...');
    const searchTerm = document.getElementById('searchInput').value;
    const dateFilter = document.getElementById('dateFilter') ? document.getElementById('dateFilter').value : '';
    const customerFilter = document.getElementById('customerFilter') ? document.getElementById('customerFilter').value : '';
    const amountFilter = document.getElementById('amountFilter') ? document.getElementById('amountFilter').value : '';
    const sortBy = document.getElementById('sortByFilter') ? document.getElementById('sortByFilter').value : 'date';
    
    const params = new URLSearchParams();
    if (searchTerm) params.append('search', searchTerm);
    if (dateFilter) params.append('date', dateFilter);
    if (customerFilter) params.append('customer', customerFilter);
    if (amountFilter) params.append('amount', amountFilter);
    if (sortBy) params.append('sort', sortBy);
    
    fetch(`/api/sales/table?${params.toString()}`)
        .then(response => response.text())
        .then(data => {
            console.log('Sales table loaded');
            document.getElementById('salesTable').innerHTML = data;
            document.getElementById('resultsCount').textContent = 'Sales loaded successfully';
            addActionListeners();
        })
        .catch(error => {
            console.error('Error loading sales table:', error);
            document.getElementById('salesTable').innerHTML = '<div class="alert alert-danger">Error loading sales table</div>';
            document.getElementById('resultsCount').textContent = 'Error loading sales';
        });
}

// Add action listeners to buttons
function addActionListeners() {
    console.log('Adding action listeners...');
    
    // Add click listeners to view buttons
    document.querySelectorAll('.btn-view').forEach(button => {
        button.addEventListener('click', function() {
            const billNo = this.getAttribute('data-bill-no');
            console.log('Viewing sale:', billNo);
            openSaleModal(billNo, 'view');
        });
    });
    
    // Add click listeners to edit buttons
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            const billNo = this.getAttribute('data-bill-no');
            console.log('Editing sale:', billNo);
            openSaleModal(billNo, 'edit');
        });
    });
    
    // Add click listeners to delete buttons
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', function() {
            const billNo = this.getAttribute('data-bill-no');
            console.log('Deleting sale:', billNo);
            deleteSale(billNo);
        });
    });
}

// Open sale modal
function openSaleModal(billNo, action) {
    console.log('Opening sale modal:', billNo, action);
    currentModalType = action; // Set current modal type
    const modal = new bootstrap.Modal(document.getElementById('saleModal'));
    
    if (action === 'add') {
        fetch('/api/sales/add-form')
            .then(response => response.text())
            .then(data => {
                document.querySelector('#saleModal .modal-content').innerHTML = data;
                modal.show();
            })
            .catch(error => {
                console.error('Error loading add form:', error);
                alert('Error loading add form. Please try again.');
            });
    } else {
        fetch(`/api/sales/${action}/${billNo}`)
            .then(response => response.text())
            .then(data => {
                document.querySelector('#saleModal .modal-content').innerHTML = data;
                modal.show();
            })
            .catch(error => {
                console.error('Error loading sale form:', error);
                alert('Error loading sale form. Please try again.');
            });
    }
}

// Open add sale modal
function openAddSaleModal() {
    console.log('Opening add sale modal');
    openSaleModal(null, 'add');
}

// Delete sale
function deleteSale(billNo) {
    if (confirm('Are you sure you want to delete this sale?')) {
        console.log('Deleting sale:', billNo);
        fetch(`/api/sales/delete/${billNo}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Sale deleted successfully!');
                loadSalesTable();
                loadStats();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting sale:', error);
            alert('Error deleting sale. Please try again.');
        });
    }
}

// Search functionality
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    console.log('Searching for:', searchTerm);
    loadSalesTable();
}

// Debounced search
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 500);
});

// Advanced filters
function toggleFilters() {
    const card = document.getElementById('advancedFiltersCard');
    const body = document.getElementById('filterBody');
    const chevron = document.getElementById('filterChevron');
    
    if (card.style.display === 'none') {
        card.style.display = 'block';
        body.style.display = 'block';
        chevron.className = 'fas fa-chevron-up';
    } else {
        card.style.display = 'none';
        body.style.display = 'none';
        chevron.className = 'fas fa-chevron-down';
    }
}

function applyFilters() {
    console.log('Applying filters...');
    loadSalesTable();
}

function clearFilters() {
    document.getElementById('dateFilter').value = '';
    document.getElementById('customerFilter').value = '';
    document.getElementById('amountFilter').value = '';
    document.getElementById('sortByFilter').value = 'date';
    
    console.log('Clearing filters...');
    loadSalesTable();
}

// Export sales
function exportSales() {
    console.log('Exporting sales...');
    const searchTerm = document.getElementById('searchInput').value;
    const dateFilter = document.getElementById('dateFilter') ? document.getElementById('dateFilter').value : '';
    const customerFilter = document.getElementById('customerFilter') ? document.getElementById('customerFilter').value : '';
    const amountFilter = document.getElementById('amountFilter') ? document.getElementById('amountFilter').value : '';
    const sortBy = document.getElementById('sortByFilter') ? document.getElementById('sortByFilter').value : 'date';
    
    const params = new URLSearchParams();
    if (searchTerm) params.append('search', searchTerm);
    if (dateFilter) params.append('date', dateFilter);
    if (customerFilter) params.append('customer', customerFilter);
    if (amountFilter) params.append('amount', amountFilter);
    if (sortBy) params.append('sort', sortBy);
    
    const exportUrl = `/api/sales/export?${params.toString()}`;
    window.open(exportUrl, '_blank');
    console.log('Export initiated');
}

// Global variables for sale form
let saleItemsList = [];
let saleItemRowCounter = 0;
let currentModalType = 'add'; // Track current modal type

// Initialize sale form when modal opens
function initializeSaleForm() {
    console.log('Initializing sale form...');
    
    // Reset form when modal opens
    saleItemRowCounter = 0;
    const tbody = document.getElementById('saleItemsTableBody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('sale_bill_date');
    if (dateInput) {
        dateInput.value = today;
    }
    
    // Add first item row immediately
    addSaleItemRow();
}

// Initialize edit sale form
function initializeEditSaleForm() {
    console.log('Initializing edit sale form...');
    console.log('window.editSaleData:', window.editSaleData);
    console.log('window.saleItemsData:', window.saleItemsData);
    
    // Reset form
    saleItemRowCounter = 0;
    const tbody = document.getElementById('editSaleItemsTableBody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    // Load existing sale items - FIXED APPROACH
    let saleItems = [];
    
    // Try multiple ways to get the data
    if (window.editSaleData && Array.isArray(window.editSaleData)) {
        saleItems = window.editSaleData;
        console.log('Found sale items in window.editSaleData:', saleItems.length);
    } else if (window.editSaleData && typeof window.editSaleData === 'string') {
        try {
            saleItems = JSON.parse(window.editSaleData);
            console.log('Parsed sale items from string:', saleItems.length);
        } catch (e) {
            console.error('Error parsing editSaleData string:', e);
        }
    } else {
        console.log('No sale items found in window.editSaleData, trying to fetch from server...');
        
        // Get bill number from the form
        const billNoInput = document.getElementById('edit_bill_no');
        if (billNoInput) {
            const billNo = billNoInput.value;
            console.log('Fetching sale items for bill:', billNo);
            
            // Fetch sale items directly from server
            fetch(`/api/sales/items/${billNo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.items) {
                        saleItems = data.items;
                        console.log('Fetched sale items from server:', saleItems);
                        
                        // Add items to the form
                        if (saleItems.length > 0) {
                            saleItems.forEach((item, index) => {
                                console.log(`Adding item ${index}:`, item);
                                addEditSaleItemRow(item);
                            });
                        } else {
                            console.log('No items found, adding default row');
                            addEditSaleItemRow();
                        }
                        
                        // Calculate totals
                        calculateEditSaleBillTotal();
                    } else {
                        console.log('No items found in server response, adding default row');
                        addEditSaleItemRow();
                        calculateEditSaleBillTotal();
                    }
                })
                .catch(error => {
                    console.error('Error fetching sale items:', error);
                    console.log('Adding default row due to error');
                    addEditSaleItemRow();
                    calculateEditSaleBillTotal();
                });
            return; // Exit early since we're fetching asynchronously
        }
    }
    
    console.log('Loading sale items:', saleItems.length);
    console.log('Sale items data:', saleItems);
    
    if (saleItems.length > 0) {
        saleItems.forEach((item, index) => {
            console.log(`Adding item ${index}:`, item);
            addEditSaleItemRow(item);
        });
    } else {
        console.log('No sale items found, adding default row');
        // Add one default row if no items exist
        addEditSaleItemRow();
    }
    
    // Calculate totals
    calculateEditSaleBillTotal();
}

// Sale form functions - these need to be global
function addSaleItemRow() {
    console.log('Adding sale item row...');
    const tbody = document.getElementById('saleItemsTableBody');
    if (!tbody) {
        console.error('saleItemsTableBody not found');
        return;
    }
    
    const rowId = `sale_row_${saleItemRowCounter}`;
    
    // Get items from global data
    let items = window.saleItemsData || [];
    console.log('Items loaded:', items.length, 'Items data:', items);
    
    // If no items, try to get from server
    if (items.length === 0) {
        console.log('No items found, trying to fetch from server...');
        fetch('/api/items/list')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.items) {
                    window.saleItemsData = data.items;
                    items = data.items;
                    console.log('Items fetched from server:', items);
                    // Re-render the current row with items
                    const currentRow = document.getElementById(rowId);
                    if (currentRow) {
                        const itemSelect = currentRow.querySelector('.sale-item-select');
                        if (itemSelect) {
                            itemSelect.innerHTML = '<option value="">Select Item</option>' + 
                                items.map(item => `<option value="${item.it_cd}" data-rate="${item.rate || 0}" data-gst="${item.gst || 0}">${item.it_cd} - ${item.it_nm}</option>`).join('');
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching items:', error);
            });
    }
    
    const row = document.createElement('tr');
    row.id = rowId;
    row.innerHTML = `
        <td>
            <select class="form-select bright-input sale-item-select" onchange="onSaleItemSelect(${saleItemRowCounter})" required>
                <option value="">Select Item</option>
                ${items.map(item => `<option value="${item.it_cd}" data-rate="${item.rate || 0}" data-gst="${item.gst || 0}">${item.it_cd} - ${item.it_nm}</option>`).join('')}
            </select>
        </td>
        <td>
            <input type="number" class="form-control bright-input sale-qty-input" step="0.01" min="0" value="1" onchange="calculateSaleRowTotal(${saleItemRowCounter})" required>
        </td>
        <td>
            <input type="number" class="form-control bright-input sale-rate-input" step="0.01" min="0" value="0.00" onchange="calculateSaleRowTotal(${saleItemRowCounter})" required>
        </td>
        <td>
            <input type="number" class="form-control bright-input sale-amount-input" step="0.01" readonly>
        </td>
        <td>
            <input type="number" class="form-control bright-input sale-discount-input" step="0.01" min="0" value="0.00" onchange="calculateSaleRowTotal(${saleItemRowCounter})">
        </td>
        <td>
            <input type="number" class="form-control bright-input sale-net-amount-input" step="0.01" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeSaleItemRow(${saleItemRowCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    saleItemRowCounter++;
    console.log('Sale item row added, counter:', saleItemRowCounter);
}

function removeSaleItemRow(rowIndex) {
    const row = document.getElementById(`sale_row_${rowIndex}`);
    if (row) {
        row.remove();
        calculateSaleBillTotal();
    }
}

function onSaleItemSelect(rowIndex) {
    const row = document.getElementById(`sale_row_${rowIndex}`);
    if (!row) return;
    
    const itemSelect = row.querySelector('.sale-item-select');
    const rateInput = row.querySelector('.sale-rate-input');
    
    if (itemSelect.value) {
        const selectedOption = itemSelect.options[itemSelect.selectedIndex];
        const rate = selectedOption.getAttribute('data-rate') || 0;
        rateInput.value = rate;
        calculateSaleRowTotal(rowIndex);
    }
}

function calculateSaleRowTotal(rowIndex) {
    const row = document.getElementById(`sale_row_${rowIndex}`);
    if (!row) return;
    
    const qtyInput = row.querySelector('.sale-qty-input');
    const rateInput = row.querySelector('.sale-rate-input');
    const discountInput = row.querySelector('.sale-discount-input');
    const amountInput = row.querySelector('.sale-amount-input');
    const netAmountInput = row.querySelector('.sale-net-amount-input');
    
    const qty = parseFloat(qtyInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    const discount = parseFloat(discountInput.value) || 0;
    
    const amount = qty * rate;
    const netAmount = amount - discount;
    
    amountInput.value = amount.toFixed(2);
    netAmountInput.value = netAmount.toFixed(2);
    
    calculateSaleBillTotal();
}

function calculateSaleBillTotal() {
    let subTotal = 0;
    let totalDiscount = 0;
    
    const rows = document.querySelectorAll('#saleItemsTableBody tr');
    rows.forEach(row => {
        const amount = parseFloat(row.querySelector('.sale-amount-input').value) || 0;
        const discount = parseFloat(row.querySelector('.sale-discount-input').value) || 0;
        
        subTotal += amount;
        totalDiscount += discount;
    });
    
    const gstAmount = subTotal * 0.18; // 18% GST
    const grandTotal = subTotal - totalDiscount + gstAmount;
    
    const subTotalInput = document.getElementById('sale_sub_total');
    const totalDiscountInput = document.getElementById('sale_total_discount');
    const gstAmountInput = document.getElementById('sale_gst_amount');
    const grandTotalInput = document.getElementById('sale_grand_total');
    
    if (subTotalInput) subTotalInput.value = subTotal.toFixed(2);
    if (totalDiscountInput) totalDiscountInput.value = totalDiscount.toFixed(2);
    if (gstAmountInput) gstAmountInput.value = gstAmount.toFixed(2);
    if (grandTotalInput) grandTotalInput.value = grandTotal.toFixed(2);
}

function saveSale(event) {
    event.preventDefault();
    
    // Validate form
    const billNo = document.getElementById('sale_bill_no').value;
    const billDate = document.getElementById('sale_bill_date').value;
    const partyCd = document.getElementById('sale_party_cd').value;
    
    if (!billNo || !billDate || !partyCd) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Collect items data
    const items = [];
    const rows = document.querySelectorAll('#saleItemsTableBody tr');
    let hasItems = false;
    
    rows.forEach(row => {
        const itemSelect = row.querySelector('.sale-item-select');
        const qtyInput = row.querySelector('.sale-qty-input');
        const rateInput = row.querySelector('.sale-rate-input');
        const discountInput = row.querySelector('.sale-discount-input');
        
        if (itemSelect.value && qtyInput.value && rateInput.value) {
            items.push({
                it_cd: itemSelect.value,
                qty: parseFloat(qtyInput.value),
                rate: parseFloat(rateInput.value),
                discount: parseFloat(discountInput.value) || 0
            });
            hasItems = true;
        }
    });
    
    if (!hasItems) {
        alert('Please add at least one item');
        return;
    }
    
    // Prepare data for submission
    const saleData = {
        bill_no: parseInt(billNo),
        bill_date: billDate,
        party_cd: partyCd,
        items: items,
        sub_total: parseFloat(document.getElementById('sale_sub_total').value),
        total_discount: parseFloat(document.getElementById('sale_total_discount').value),
        gst_amount: parseFloat(document.getElementById('sale_gst_amount').value),
        grand_total: parseFloat(document.getElementById('sale_grand_total').value)
    };
    
    // Submit to API
    fetch('/api/sales/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Sale bill saved successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the sale bill.');
    });
}

// Edit sale form functions
function addEditSaleItemRow(itemData = null) {
    console.log('addEditSaleItemRow called with itemData:', itemData);
    
    const tbody = document.getElementById('editSaleItemsTableBody');
    if (!tbody) {
        console.error('editSaleItemsTableBody not found');
        return;
    }
    
    const rowId = `edit_sale_row_${saleItemRowCounter}`;
    
    // Get items from global data - ENHANCED DATA ACCESS
    let items = [];
    
    // Try multiple ways to get the data
    if (window.saleItemsData && Array.isArray(window.saleItemsData)) {
        items = window.saleItemsData;
        console.log('Using window.saleItemsData (array):', items.length);
    } else if (window.saleItemsData && typeof window.saleItemsData === 'string') {
        try {
            items = JSON.parse(window.saleItemsData);
            console.log('Parsed window.saleItemsData from string:', items.length);
        } catch (e) {
            console.error('Error parsing saleItemsData string:', e);
        }
    } else if (window.saleItemsData && typeof window.saleItemsData === 'object') {
        items = window.saleItemsData;
        console.log('Using window.saleItemsData (object):', items.length);
    } else {
        console.log('No saleItemsData available, trying to fetch from server...');
        
        // Try to fetch items from server as fallback
        fetch('/api/items/list')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.items) {
                    items = data.items;
                    console.log('Fetched items from server:', items.length);
                    // Continue with row creation
                    createEditSaleItemRow(itemData, items, rowId, tbody);
                } else {
                    console.log('No items found in server response');
                    createEditSaleItemRow(itemData, [], rowId, tbody);
                }
            })
            .catch(error => {
                console.error('Error fetching items:', error);
                createEditSaleItemRow(itemData, [], rowId, tbody);
            });
        return; // Exit early since we're fetching asynchronously
    }
    
    console.log('Items loaded for edit:', items.length);
    console.log('Available items:', items);
    
    // Create the row with the items data
    createEditSaleItemRow(itemData, items, rowId, tbody);
}

function createEditSaleItemRow(itemData, items, rowId, tbody) {
    // If itemData is provided, use it to populate the row
    const selectedItem = itemData ? itemData.it_cd : '';
    const qty = itemData ? itemData.qty : 1;
    const rate = itemData ? itemData.rate : 0.00;
    const discount = itemData ? itemData.discount : 0.00;
    const amount = itemData ? itemData.amount : 0.00;
    const netAmount = amount - discount;
    
    console.log('Row data:', {
        selectedItem,
        qty,
        rate,
        discount,
        amount,
        netAmount
    });
    
    // Generate options for the select dropdown
    const options = items.map(item => {
        const selected = item.it_cd === selectedItem ? 'selected' : '';
        return `<option value="${item.it_cd}" data-rate="${item.rate || 0}" data-gst="${item.gst || 0}" ${selected}>${item.it_cd} - ${item.it_nm}</option>`;
    }).join('');
    
    console.log('Generated options:', options);
    
    const row = document.createElement('tr');
    row.id = rowId;
    
    row.innerHTML = `
        <td>
            <select class="form-select bright-input edit-sale-item-select" onchange="onEditSaleItemSelect(${saleItemRowCounter})" required>
                <option value="">Select Item</option>
                ${options}
            </select>
        </td>
        <td>
            <input type="number" class="form-control bright-input edit-sale-qty-input" step="0.01" min="0" value="${qty}" onchange="calculateEditSaleRowTotal(${saleItemRowCounter})" required>
        </td>
        <td>
            <input type="number" class="form-control bright-input edit-sale-rate-input" step="0.01" min="0" value="${rate}" onchange="calculateEditSaleRowTotal(${saleItemRowCounter})" required>
        </td>
        <td>
            <input type="number" class="form-control bright-input edit-sale-amount-input" step="0.01" value="${amount}" readonly>
        </td>
        <td>
            <input type="number" class="form-control bright-input edit-sale-discount-input" step="0.01" min="0" value="${discount}" onchange="calculateEditSaleRowTotal(${saleItemRowCounter})">
        </td>
        <td>
            <input type="number" class="form-control bright-input edit-sale-net-amount-input" step="0.01" value="${netAmount}" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeEditSaleItemRow(${saleItemRowCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    saleItemRowCounter++;
    
    console.log('Row added successfully with ID:', rowId);
}
    

}

function removeEditSaleItemRow(rowIndex) {
    const row = document.getElementById(`edit_sale_row_${rowIndex}`);
    if (row) {
        row.remove();
        calculateEditSaleBillTotal();
    }
}

function onEditSaleItemSelect(rowIndex) {
    const row = document.getElementById(`edit_sale_row_${rowIndex}`);
    if (!row) return;
    
    const itemSelect = row.querySelector('.edit-sale-item-select');
    const rateInput = row.querySelector('.edit-sale-rate-input');
    
    if (itemSelect.value) {
        const selectedOption = itemSelect.options[itemSelect.selectedIndex];
        const rate = selectedOption.getAttribute('data-rate') || 0;
        rateInput.value = rate;
        calculateEditSaleRowTotal(rowIndex);
    }
}

function calculateEditSaleRowTotal(rowIndex) {
    const row = document.getElementById(`edit_sale_row_${rowIndex}`);
    if (!row) return;
    
    const qtyInput = row.querySelector('.edit-sale-qty-input');
    const rateInput = row.querySelector('.edit-sale-rate-input');
    const discountInput = row.querySelector('.edit-sale-discount-input');
    const amountInput = row.querySelector('.edit-sale-amount-input');
    const netAmountInput = row.querySelector('.edit-sale-net-amount-input');
    
    const qty = parseFloat(qtyInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    const discount = parseFloat(discountInput.value) || 0;
    
    const amount = qty * rate;
    const netAmount = amount - discount;
    
    amountInput.value = amount.toFixed(2);
    netAmountInput.value = netAmount.toFixed(2);
    
    calculateEditSaleBillTotal();
}

function calculateEditSaleBillTotal() {
    let subTotal = 0;
    let totalDiscount = 0;
    
    const rows = document.querySelectorAll('#editSaleItemsTableBody tr');
    rows.forEach(row => {
        const amount = parseFloat(row.querySelector('.edit-sale-amount-input').value) || 0;
        const discount = parseFloat(row.querySelector('.edit-sale-discount-input').value) || 0;
        
        subTotal += amount;
        totalDiscount += discount;
    });
    
    const gstAmount = subTotal * 0.18; // 18% GST
    const grandTotal = subTotal - totalDiscount + gstAmount;
    
    const subTotalInput = document.getElementById('edit_sub_total');
    const totalDiscountInput = document.getElementById('edit_total_discount');
    const gstAmountInput = document.getElementById('edit_gst_amount');
    const grandTotalInput = document.getElementById('edit_grand_total');
    
    if (subTotalInput) subTotalInput.value = subTotal.toFixed(2);
    if (totalDiscountInput) totalDiscountInput.value = totalDiscount.toFixed(2);
    if (gstAmountInput) gstAmountInput.value = gstAmount.toFixed(2);
    if (grandTotalInput) grandTotalInput.value = grandTotal.toFixed(2);
}

function updateSale(event) {
    event.preventDefault();
    
    console.log('=== UPDATE SALE FUNCTION CALLED ===');
    
    // Validate form
    const billNo = document.getElementById('edit_bill_no').value;
    const billDate = document.getElementById('edit_bill_date').value;
    const partyCd = document.getElementById('edit_party_cd').value;
    
    console.log('Form validation:', { billNo, billDate, partyCd });
    
    if (!billNo || !billDate || !partyCd) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Collect items data
    const items = [];
    const rows = document.querySelectorAll('#editSaleItemsTableBody tr');
    let hasItems = false;
    
    console.log('Found rows:', rows.length);
    
    rows.forEach((row, index) => {
        const itemSelect = row.querySelector('.edit-sale-item-select');
        const qtyInput = row.querySelector('.edit-sale-qty-input');
        const rateInput = row.querySelector('.edit-sale-rate-input');
        const discountInput = row.querySelector('.edit-sale-discount-input');
        
        console.log(`Row ${index}:`, {
            itemSelect: itemSelect ? itemSelect.value : 'not found',
            qtyInput: qtyInput ? qtyInput.value : 'not found',
            rateInput: rateInput ? rateInput.value : 'not found',
            discountInput: discountInput ? discountInput.value : 'not found'
        });
        
        if (itemSelect && itemSelect.value && qtyInput && qtyInput.value && rateInput && rateInput.value) {
            const itemData = {
                it_cd: itemSelect.value,
                qty: parseFloat(qtyInput.value),
                rate: parseFloat(rateInput.value),
                discount: parseFloat(discountInput.value) || 0
            };
            items.push(itemData);
            hasItems = true;
            console.log(`Added item ${index}:`, itemData);
        }
    });
    
    console.log('Collected items:', items);
    console.log('Has items:', hasItems);
    
    if (!hasItems) {
        alert('Please add at least one item');
        return;
    }
    
    // Prepare data for submission
    const saleData = {
        bill_no: parseInt(billNo),
        bill_date: billDate,
        party_cd: partyCd,
        items: items,
        sub_total: parseFloat(document.getElementById('edit_sub_total').value) || 0,
        total_discount: parseFloat(document.getElementById('edit_total_discount').value) || 0,
        gst_amount: parseFloat(document.getElementById('edit_gst_amount').value) || 0,
        grand_total: parseFloat(document.getElementById('edit_grand_total').value) || 0
    };
    
    console.log('Sale data to submit:', saleData);
    
    // Get bill number from the form
    const currentBillNo = billNo;
    
    console.log('Submitting to:', `/api/sales/update/${currentBillNo}`);
    
    // Submit to API
    fetch(`/api/sales/update/${currentBillNo}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(result => {
        console.log('API response:', result);
        if (result.success) {
            alert('Sale bill updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the sale bill.');
    });
}

// Global variable initialization
window.saleItemsData = window.saleItemsData || [];
window.salePartiesData = window.salePartiesData || [];
window.editSaleData = window.editSaleData || [];

// Modal event handlers
document.addEventListener('DOMContentLoaded', function() {
    const saleModal = document.getElementById('saleModal');
    if (saleModal) {
        saleModal.addEventListener('hidden.bs.modal', function() {
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';
            console.log('Modal closed, scrollbar restored');
        });
        saleModal.addEventListener('shown.bs.modal', function() {
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';
            console.log('Modal shown, scrollbar maintained');
            
            // Initialize form based on modal type
            setTimeout(function() {
                if (currentModalType === 'edit') {
                    console.log('Initializing edit form...');
                    console.log('Global data before init:', {
                        saleItemsData: window.saleItemsData,
                        salePartiesData: window.salePartiesData,
                        editSaleData: window.editSaleData
                    });
                    initializeEditSaleForm();
                } else if (currentModalType === 'add') {
                    console.log('Initializing add form...');
                    initializeSaleForm();
                }
                // For 'view' action, no initialization needed as it's read-only
            }, 100);
        });
    }
});
</script>
{% endblock %} 